<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet" />
    <title>Create Account - Kingdom Hall Attendant</title>
</head>
<body>
    <div class="container" style="max-width: 450px;margin-top: 50px;">
        <form method="post" action="{{ url_for('register_v2') }}" id="register-form">
            <div class="input-box">
                <label for="email">Correo electrónico</label>
                <input type="email" id="email" name="email" required autocomplete="off">
            </div>
            <button type="submit" class="submit-btn">Registrarse</button>
        </form>
    </div>
    <script>
document.getElementById('register-form').addEventListener('submit', async function(event) {
    event.preventDefault(); // Evita el envío del formulario por defecto
    const email = document.getElementById('email').value;

    // Enviar el correo electrónico al servidor para registrar al usuario
    const response = await fetch('/v2/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email: email})
    });

    const result = await response.json();
    if (result.status === 'ok') {
        // Si el registro fue exitoso, solicitar opciones de WebAuthn
        const webAuthnResponse = await fetch('/start-webauthn-registration', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });

        let webAuthnOptions = await webAuthnResponse.json();
        if (typeof webAuthnOptions === 'string') {
            webAuthnOptions = JSON.parse(webAuthnOptions);
        }

        // Asegúrate de que solo se use el tipo 'publicKey'
        try {
            const publicKeyOptions = webAuthnOptions.publicKey;  // Extraer las opciones publicKey
            console.log(publicKeyOptions);  // Puedes usar esto para inspeccionar la estructura en la consola

            const credential = await navigator.credentials.create({
                publicKey: publicKeyOptions  // Asegúrate de que `publicKeyOptions` tenga la estructura correcta
            });


            // Procesar la respuesta de WebAuthn
            const webauthnResponse = {
                id: credential.id,
                rawId: Array.from(new Uint8Array(credential.rawId)),
                type: credential.type,
                response: {
                    attestationObject: Array.from(new Uint8Array(credential.response.attestationObject)),
                    clientDataJSON: Array.from(new Uint8Array(credential.response.clientDataJSON))
                }
            };

            // Enviar la respuesta de WebAuthn al servidor para verificar el registro
            const verifyResponse = await fetch('/verify-webauthn-registration', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(webauthnResponse)
            });

            const verificationResult = await verifyResponse.json();
            if (verificationResult.status === 'ok') {
                // Si la verificación es exitosa, redirigir al usuario a /login
                window.location.href = '/login';
            } else {
                alert('Error al registrar el dispositivo.');
            }
        } catch (error) {
            console.error('Error al crear las credenciales:', error);
            alert('Error al solicitar datos biométricos. Asegúrate de que tu dispositivo soporte WebAuthn.');
        }
    } else {
        alert('Error: ' + result.reason);
    }
});
        </script>
</body>
</html>